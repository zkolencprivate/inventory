{
	"name": "Dimensions 1",
	"properties": {
		"content": {
			"query": " CREATE SCHEMA [dwh]\n\n\nDROP TABLE [dbo].[customers]\nGO\n\nSET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE TABLE [dbo].[customers]\n( \n    [Customer_code] [varchar](128)  NULL,\n    [Customer_Name] [varchar](128)  NULL,\n    [Customer_Address] [varchar](128)  NULL,\n    [Customer_Contact] [varchar](128)  NULL\n)\nWITH\n(\n    DISTRIBUTION = HASH ( [Customer_code] ),\n    CLUSTERED COLUMNSTORE INDEX\n)\nGO\n\nDROP TABLE [dbo].[suppliers]\nGO\n\nSET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE TABLE [dbo].[suppliers]\n( \n    [supplier_Code] [varchar](128)  NULL,\n    [supplier_Name] [varchar](128)  NULL,\n    [supplier_Address] [varchar](128)  NULL,\n    [supplier_Contact] [varchar](128)  NULL,\n    [supplier_type] [varchar](128)  NULL\n)\nWITH\n(\n    DISTRIBUTION = ROUND_ROBIN,\n    CLUSTERED COLUMNSTORE INDEX\n)\nGO\n\n\n\n\n\n\n\n\nDROP TABLE [dwh].[d_customers]\nGO\n\nSET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE TABLE [dwh].[d_customers]\n( \n    [Customer_ID] [int] IDENTITY(1,1)  NOT NULL,\n    [Customer_Code] [varchar](128)  NULL,\n    [Customer_Name] [varchar](128)  NULL,\n    [Customer_Address] [varchar](128)  NULL,\n    [Customer_Contact] [varchar](128)  NULL,\n    [StartDate] [date]  NULL,\n    [EndDate] [date]  NULL,\n    [IsCurrent] [varchar](1)  NULL\n)\nWITH\n(\n    DISTRIBUTION = ROUND_ROBIN,\n    CLUSTERED COLUMNSTORE INDEX\n)\nGO\n\n\n\nDROP TABLE [dwh].[d_suppliers]\nGO\n\nSET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE TABLE [dwh].[d_suppliers]\n( \n    [supplier_ID] [int] IDENTITY(1,1)   NOT NULL,\n    [supplier_Code] [varchar](128)  NULL,\n    [supplier_Name] [varchar](128)  NULL,\n    [supplier_Address] [varchar](128)  NULL,\n    [supplier_Contact] [varchar](128)  NULL,\n    [supplier_type] [varchar](128)  NULL,\n    [StartDate] [date]  NULL,\n    [EndDate] [date]  NULL,\n    [IsCurrent] [varchar](1)  NULL\n)\nWITH\n(\n    DISTRIBUTION = ROUND_ROBIN,\n    CLUSTERED COLUMNSTORE INDEX\n)\nGO\n\n\n\n——————\nSET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE PROC [dbo].[bulk_load_d_customers] AS\nBEGIN\n\n    truncate table dbo.customers;\n\n    COPY INTO dbo.customers\n    (customer_code 1, customer_name 2, customer_address 3, customer_contact 4)\n    FROM 'https://zkolencstorageaccount.dfs.core.windows.net/zkolencfilesystemname/customers.csv'\n    WITH\n    (\n        FILE_TYPE = 'CSV'\n        ,MAXERRORS = 0\n        ,FIELDTERMINATOR = ';'\n        ,ERRORFILE = 'https://zkolencstorageaccount.dfs.core.windows.net/zkolencfilesystemname/'\n    );\n\n    -- Mark current records as no longer current\n    UPDATE CD\n    SET CD.EndDate = GETDATE() - 1, CD.IsCurrent = 0\n    FROM dwh.d_customers CD\n    JOIN dbo.customers CS ON CD.Customer_Code = CS.Customer_Code\n    WHERE CD.IsCurrent = 1 AND (\n        CD.Customer_Name <> CS.Customer_Name OR\n        CD.Customer_Address <> CS.Customer_Address OR\n        CD.Customer_Contact <> CS.Customer_Contact\n    );\n\n\n\n    -- Insert new records for changed data\n    INSERT INTO dwh.d_customers (Customer_Code, Customer_Name, Customer_Address, Customer_Contact, StartDate, EndDate, IsCurrent)\n    SELECT CS.Customer_Code, CS.Customer_Name, CS.Customer_Address, CS.Customer_Contact, GETDATE(), '9999-12-31', 1\n    FROM dbo.customers CS\n    JOIN dwh.d_customers CD ON CS.Customer_Code = CD.Customer_Code\n    WHERE CD.IsCurrent = 0;\n\n    -- New records\n    INSERT INTO dwh.d_customers (Customer_Code, Customer_Name, Customer_Address, Customer_Contact, StartDate, EndDate, IsCurrent)\n    SELECT CS.Customer_Code, CS.Customer_Name, CS.Customer_Address, CS.Customer_Contact, GETDATE(), '9999-12-31', 1\n    FROM dbo.customers CS\n    LEFT JOIN dwh.d_customers CD ON CS.Customer_Code = CD.Customer_Code\n    WHERE CD.Customer_Code IS NULL;\n\n\nEND\nGO\n—————\nSET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE PROC [dbo].[bulk_load_d_suppliers] AS\nBEGIN\n\n    truncate table dbo.suppliers;\n\n    COPY INTO dbo.suppliers\n    (supplier_code 1, supplier_name 2, supplier_address 3, supplier_contact 4, supplier_type 5)\n    FROM 'https://zkolencstorageaccount.dfs.core.windows.net/zkolencfilesystemname/suppliers.csv'\n    WITH\n    (\n        FILE_TYPE = 'CSV'\n        ,MAXERRORS = 0\n        ,FIELDTERMINATOR = ';'\n        ,ERRORFILE = 'https://zkolencstorageaccount.dfs.core.windows.net/zkolencfilesystemname/'\n    );\n\n    -- Mark current records as no longer current\n    UPDATE CD\n    SET CD.EndDate = GETDATE() - 1, CD.IsCurrent = 0\n    FROM dwh.d_suppliers CD\n    JOIN dbo.suppliers CS ON CD.supplier_Code = CS.supplier_Code\n    WHERE CD.IsCurrent = 1 AND (\n        CD.supplier_Name <> CS.supplier_Name OR\n        CD.supplier_Address <> CS.supplier_Address OR\n        CD.supplier_Contact <> CS.supplier_Contact OR\n        CD.supplier_Type <> CS.supplier_Type\n    );\n\n\n\n    -- Insert new records for changed data\n    INSERT INTO dwh.d_suppliers (supplier_Code, supplier_Name, supplier_Address, supplier_Contact, supplier_type, StartDate, EndDate, IsCurrent)\n    SELECT CS.supplier_Code, CS.supplier_Name, CS.supplier_Address, CS.supplier_Contact,CS.supplier_type, GETDATE(), '9999-12-31', 1\n    FROM dbo.suppliers CS\n    JOIN dwh.d_suppliers CD ON CS.supplier_Code = CD.supplier_Code\n    WHERE CD.IsCurrent = 0;\n\n    -- New records\n    INSERT INTO dwh.d_suppliers (supplier_Code, supplier_Name, supplier_Address, supplier_Contact,supplier_type, StartDate, EndDate, IsCurrent)\n    SELECT CS.supplier_Code, CS.supplier_Name, CS.supplier_Address, CS.supplier_Contact,CS.supplier_type, GETDATE(), '9999-12-31', 1\n    FROM dbo.suppliers CS\n    LEFT JOIN dwh.d_suppliers CD ON CS.supplier_Code = CD.supplier_Code\n    WHERE CD.supplier_Code IS NULL;\n\n\nEND\nGO\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "novipool",
				"poolName": "novipool"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}