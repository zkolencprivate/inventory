{
	"name": "Revenue",
	"properties": {
		"content": {
			"query": "CREATE TABLE dwh.CUSTOMER_REVENUE_BY_PERIOD (\n    CUSTOMER_CODE   VARCHAR(128),\n    REVENUE_LAST_MONTH DECIMAL(18, 2),\n    REVENUE_LAST_QUARTER DECIMAL(18, 2),\n    REVENUE_MTD DECIMAL(18, 2),\n    REVENUE_YTD DECIMAL(18, 2),\n    REVENUE_INCREASE_PCT_QnQ DECIMAL(5, 2)\n);\n\nselect * from  dwh.CUSTOMER_REVENUE_BY_PERIOD; \nselect * from dwh.f_sales;\n\n--REVENUE_LAST_MONTH\nselect DATEADD(MONTH, -1, EOMONTH(GETDATE())), EOMONTH(GETDATE())\n--2024-04-30 2024-05-31\nSELECT \n --   top 10\n    customer_code,\n    SUM(Total_Sell_Value) AS REVENUE_LAST_MONTH\nFROM \n    dwh.f_sales\nWHERE \n    sell_date > DATEADD(MONTH, -1, EOMONTH(GETDATE()))\n    AND sell_date <= EOMONTH(GETDATE())\nGROUP BY \n    customer_code\norder by  SUM(Total_Sell_Value) DESC    ;\n\n\n--REVENUE_LAST_QUARTER\nselect DATEADD(QUARTER, -1, EOMONTH(GETDATE())), EOMONTH(GETDATE());\nselect  DATEPART(QUARTER, DATEADD(QUARTER, -1, GETDATE())),YEAR(DATEADD(QUARTER, -1, GETDATE())); \n\nSELECT \n    customer_code,\n    round(SUM(Total_Sell_Value),2) AS REVENUE_LAST_QUARTER\nFROM \n    dwh.f_sales\nWHERE \n    DATEPART(QUARTER, sell_date) = DATEPART(QUARTER, DATEADD(QUARTER, -1, GETDATE()))\n    AND YEAR(sell_date) = YEAR(DATEADD(QUARTER, -1, GETDATE()))\nGROUP BY \n    customer_code;\n\n--REVENUE_CURRENT_QUARTER\n/*\nSELECT \n    customer_code,\n    SUM(Total_Sell_Value) AS REVENUE_CURRENT_QUARTER\nFROM \n    dwh.f_sales\nWHERE \n    DATEPART(QUARTER, sell_date) = DATEPART(QUARTER, GETDATE())\n    AND YEAR(sell_date) = YEAR(GETDATE())\nGROUP BY \n    customer_code;\n*/\n\n--REVENUE_MTD\nSELECT \n    customer_code,\n    SUM(Total_Sell_Value) AS REVENUE_MTD\nFROM \n     dwh.f_sales\nWHERE \n    MONTH(sell_date) = MONTH(GETDATE()) \n    AND YEAR(sell_date) = YEAR(GETDATE())\nGROUP BY \n    customer_code;  \n\n--REVENUE_YTD\nSELECT \n    customer_code,\n    SUM(Total_Sell_Value) AS REVENUE_YTD\nFROM \n    dwh.f_sales\nWHERE \n    YEAR(sell_date) = YEAR(GETDATE())\n    and sell_date <= GETDATE()\nGROUP BY \n    customer_code;  \n\n--REVENUE_INCREASE_PCT_QnQ\nWITH QuarterlyRevenue AS (\n    SELECT \n        customer_code,\n        SUM(Total_Sell_Value) AS revenue,\n        YEAR(sell_date) AS year,\n        DATEPART(QUARTER, sell_date) AS quarter\n    FROM \n        dwh.f_sales\n    WHERE \n        YEAR(sell_date) = YEAR(GETDATE())\n        --and DATEPART(QUARTER, sell_date)  <= DATEPART(QUARTER, GETDATE())   --current_date data, 1st and 2nd quarter\n    GROUP BY customer_code, YEAR(sell_date), DATEPART(QUARTER, sell_date)\n    --order by customer_code, YEAR(sell_date), DATEPART(QUARTER, sell_date)\n)\nSELECT \n    customer_code,\n    revenue,\n    year,\n    quarter,\n    LAG(revenue) OVER (PARTITION BY customer_code ORDER BY year, quarter) AS previous_quarter_revenue,\n   round(\n    (\n    (\n        revenue - LAG(revenue) OVER (PARTITION BY customer_code ORDER BY year, quarter)\n    ) \n    / LAG(revenue) OVER (PARTITION BY customer_code ORDER BY year, quarter)\n    ) * 100\n    , 2\n    ) AS REVENUE_INCREASE_PCT_QnQ\nFROM \n    QuarterlyRevenue\nORDER BY \n    customer_code, year, quarter;\n\ndrop view dwh.v_revenue_qnq;\ncreate view dwh.v_revenue_qnq AS\n    --REVENUE_INCREASE_PCT_QnQ\nWITH QuarterlyRevenue AS (\n    SELECT \n        customer_code,\n        SUM(Total_Sell_Value) AS revenue,\n        YEAR(sell_date) AS year,\n        DATEPART(QUARTER, sell_date) AS quarter\n    FROM \n        dwh.f_sales\n    WHERE \n        YEAR(sell_date) = YEAR(GETDATE())\n        --and DATEPART(QUARTER, sell_date)  <= DATEPART(QUARTER, GETDATE())   --current_date data, 1st and 2nd quarter\n    GROUP BY customer_code, YEAR(sell_date), DATEPART(QUARTER, sell_date)\n    --order by customer_code, YEAR(sell_date), DATEPART(QUARTER, sell_date)\n)\nSELECT \n    customer_code,\n    cst.cst_name,\n    cst.cst_address,\n    cst.cst_contact,\n    revenue,\n    year,\n    quarter,\n    LAG(revenue) OVER (PARTITION BY customer_code ORDER BY year, quarter) AS previous_quarter_revenue,\n   round(\n    (\n    (\n        revenue - LAG(revenue) OVER (PARTITION BY customer_code ORDER BY year, quarter)\n    ) \n    / LAG(revenue) OVER (PARTITION BY customer_code ORDER BY year, quarter)\n    ) * 100\n    , 2\n    ) AS REVENUE_INCREASE_PCT_QnQ\nFROM \n    QuarterlyRevenue\nJOIN\n(\n    select customer_code ,  customer_name ,   customer_address ,   customer_contact  from dwh.d_customers cst where iscurrent = 1\n) cst\non QuarterlyRevenue.customer_code = cst.customer_code;\n\n\n\nselect * from dwh.v_revenue_qnq \nORDER BY \n    customer_code, year, quarter;\n\n\n--for 2024-07-15\ninsert into  dwh.CUSTOMER_REVENUE_BY_PERIOD (\n    CUSTOMER_CODE   ,\n    REVENUE_LAST_MONTH,\n    REVENUE_LAST_QUARTER,\n    REVENUE_MTD ,\n    REVENUE_YTD ,\n    REVENUE_INCREASE_PCT_QnQ\n)\nselect  \n    cust.customer_code   CUSTOMER_CODE,\n    rev_lm.REVENUE_LAST_MONTH,\n    rev_lastq.REVENUE_LAST_QUARTER,\n    rev_mtd.REVENUE_MTD ,\n    rev_ytd.REVENUE_YTD ,\n    rev_qnq.REVENUE_INCREASE_PCT_QnQ\n\nFROM\n(\n    select * from dwh.d_customers where iscurrent = 1\n) cust\nleft JOIN\n(\n    SELECT \n        customer_code,\n        round(SUM(Total_Sell_Value),2) AS REVENUE_MTD\n    FROM \n        dwh.f_sales\n    WHERE \n        MONTH(sell_date) = MONTH('2024-07-15')\n        AND YEAR(sell_date) = YEAR('2024-07-15')\n    GROUP BY \n        customer_code\n) rev_mtd\non cust.customer_code = rev_mtd.customer_code\nleft JOIN\n(\n    SELECT \n        customer_code,\n        round(SUM(Total_Sell_Value),2) AS REVENUE_LAST_QUARTER\n    FROM \n        dwh.f_sales\n    WHERE \n        DATEPART(QUARTER, sell_date) = DATEPART(QUARTER, DATEADD(QUARTER, -1, '2024-07-15'))\n        AND YEAR(sell_date) = YEAR(DATEADD(QUARTER, -1, '2024-07-15'))\n    GROUP BY \n        customer_code\n) rev_lastq\non cust.customer_code = rev_lastq.customer_code\nleft JOIN\n(\nSELECT \n    customer_code,\n    SUM(Total_Sell_Value) AS REVENUE_LAST_MONTH\nFROM \n    dwh.f_sales\nWHERE \n    sell_date > DATEADD(MONTH, -1, EOMONTH('2024-07-15'))\n    AND sell_date <= EOMONTH('2024-07-15')\nGROUP BY \n    customer_code\n) rev_lm\non cust.Customer_Code = rev_lm.customer_code\nleft JOIN\n(\n    SELECT \n    customer_code,\n    SUM(Total_Sell_Value) AS REVENUE_YTD\n    FROM \n        dwh.f_sales\n    WHERE \n        YEAR(sell_date) = YEAR('2024-07-15')\n        and sell_date <= '2024-07-15'\n    GROUP BY \n        customer_code\n) rev_ytd\non cust.customer_code = rev_ytd.customer_code\nleft JOIN\n(\nselect customer_code, REVENUE_INCREASE_PCT_QnQ from dwh.v_revenue_qnq where quarter = DATEPART(QUARTER, DATEADD(QUARTER, -1, '2024-07-15'))\n) rev_qnq\non cust.customer_code = rev_qnq.customer_code;\n\n\nselect * from dwh.CUSTOMER_REVENUE_BY_PERIOD;\n\n\nSELECT TOP 20 customer_code, round(SUM(Total_Sell_Value),2) AS TotalRevenue\nFROM dwh.f_sales\nwhere  YEAR(sell_date) = YEAR('2024-07-15')\nGROUP BY customer_code\nORDER BY TotalRevenue DESC;\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "novipool",
				"poolName": "novipool"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}