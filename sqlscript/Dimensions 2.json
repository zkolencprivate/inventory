{
	"name": "Dimensions 2",
	"properties": {
		"content": {
			"query": "drop table [dbo].[products]\nCREATE TABLE [dbo].[products]\n(\n    product_Name [varchar](128)  ,\n    product_Category [varchar](128) ,\n    supplier_Code   [varchar](128),\n    product_Code     [varchar](128),\n    cost_price float,\n    sell_price  float\n)\nWITH\n(\n    DISTRIBUTION = HASH (product_code),\n    CLUSTERED COLUMNSTORE INDEX\n)\nGO\n\ndrop table [dwh].[d_products];\nCREATE TABLE [dwh].[d_products]\n(\n    product_id int IDENTITY(1,1)  NOT NULL,\n    product_Name [varchar](128)  NOT NULL,\n    product_Category_code [varchar](128) NOT NULL,\n    supplier_Code   [varchar](128) NOT NULL,\n    product_Code     [varchar](128) NOT NULL,\n    [cost_price] float,\n    [sell_price]  float,\n    StartDate [date]  NULL,\n    EndDate [date]  NULL,\n    IsCurrent [varchar](1)  NULL\n)\nWITH\n(\n    DISTRIBUTION = HASH (product_code),\n    CLUSTERED COLUMNSTORE INDEX\n)\nGO\n\n\nCREATE TABLE [dwh].[d_product_categories]\n(\n    product_categories_id int IDENTITY(1,1)  NOT NULL,\n    product_category_code [varchar](128)  NOT NULL,\n    product_Category_name [varchar](128) NOT NULL,\n    StartDate [date]  NULL,\n    EndDate [date]  NULL,\n    IsCurrent [varchar](1)  NULL\n)\nWITH\n(\n    DISTRIBUTION = HASH (product_category_code),\n    CLUSTERED COLUMNSTORE INDEX\n)\nGO\n\ninsert into dwh.d_product_categories(product_category_code,product_Category_name,StartDate,EndDate,IsCurrent)\nvalues('TOBACCO', 'Tobacco','2023-12-31', '9999-12-31', 1);\n\ninsert into dwh.d_product_categories(product_category_code,product_Category_name,StartDate,EndDate,IsCurrent)\nvalues('BEVERAGES', 'Beverages','2023-12-31', '9999-12-31', 1);\n\ninsert into dwh.d_product_categories(product_category_code,product_Category_name,StartDate,EndDate,IsCurrent)\nvalues('FOOD', 'Food','2023-12-31', '9999-12-31', 1);\n\ninsert into dwh.d_product_categories(product_category_code,product_Category_name,StartDate,EndDate,IsCurrent)\nvalues('TOYS', 'Toys','2023-12-31', '9999-12-31', 1);\n\nCREATE TABLE [dwh].[d_warehouses]\n(\n    warehouse_id int IDENTITY(1,1)  NOT NULL,\n    warehouse_name [varchar](128) NOT NULL,\n    warehouse_address [varchar](128) NOT NULL\n)\n\ninsert into dwh.d_warehouses(warehouse_name, warehouse_address) values ('Warehouse I', '13211 Villanueva Manors, Kelseychester, MH')\ninsert into dwh.d_warehouses(warehouse_name, warehouse_address) values ('Warehouse II', '832 Torres Harbors Apt. 435, Lake Heidiberg, LA')\n\n\nselect * from dwh.d_products;\nselect * from dwh.d_product_categories;\nselect * from dwh.d_warehouses;\nselect * from dwh.d_date;\n\ndrop  PROC [dbo].[bulk_load_d_products];\nCREATE PROC [dbo].[bulk_load_d_products] AS\nBEGIN\n\n    truncate table dbo.products;\n\n    COPY INTO dbo.products\n    (product_Name 1, product_Category 2, supplier_Code 3, product_Code 4, cost_price 5, sell_price 6)\n    FROM 'https://zkolencstorageaccount.dfs.core.windows.net/zkolencfilesystemname/products_dot.csv'\n    WITH\n    (\n        FILE_TYPE = 'CSV'\n        ,MAXERRORS = 0\n        ,FIELDTERMINATOR = ';'\n        ,ERRORFILE = 'https://zkolencstorageaccount.dfs.core.windows.net/zkolencfilesystemname/'\n    );\n    \n    delete from dbo.products where product_code in ('46861','24675','55968','12083');\n\n    -- Mark current records as no longer current\n    UPDATE CD\n    SET CD.EndDate = GETDATE() - 1, CD.IsCurrent = 0\n    FROM dwh.d_products CD\n    JOIN dbo.products CS ON CD.product_Code = CS.product_Code\n    WHERE CD.IsCurrent = 1 AND (\n        CD.product_Name <> CS.product_Name OR\n        upper(CD.product_Category_code) <> upper(CS.product_Category) OR\n        CD.cost_price <> CS.cost_price OR\n        CD.sell_price <> CS.sell_price\n    );\n\n\n\n    -- Insert new records for changed data\n    INSERT INTO dwh.d_products (product_Name,product_Category_code,supplier_Code,product_Code,cost_price,sell_price,StartDate, EndDate, IsCurrent)\n    SELECT CS.product_Name, upper(CS.product_Category),CS.supplier_Code,CS.product_Code,CS.cost_price,CS.sell_price, GETDATE(), '9999-12-31', 1\n    FROM dbo.products CS\n    JOIN dwh.d_products CD ON CS.product_Code = CD.product_Code\n    WHERE CD.IsCurrent = 0;\n\n    -- New records\n    INSERT INTO dwh.d_products (product_Name,product_Category_code,supplier_Code,product_Code,cost_price,sell_price,StartDate, EndDate, IsCurrent)\n    SELECT CS.product_Name, upper(CS.product_Category),CS.supplier_Code,CS.product_Code,CS.cost_price,CS.sell_price, GETDATE(), '9999-12-31', 1\n    FROM dbo.products CS\n    LEFT JOIN dwh.d_products CD ON CS.product_Code = CD.product_Code\n    WHERE CD.product_Code IS NULL;\n\n\nEND\nGO\n\n\nGO\n\n\n\n\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "novipool",
				"poolName": "novipool"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}